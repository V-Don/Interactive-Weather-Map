<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Storm Inspector Map</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    
   <style>
        html, body { height: 100%; width: 100%; margin: 0; padding: 0; overflow: hidden; font-family: 'Inter', sans-serif; }
        #map { height: 100%; width: 100%; }
        .leaflet-popup-content-wrapper { border-radius: 8px; background-color: #f9fafb; }
        .leaflet-popup-content { margin: 15px; }
        .popup-button-remove { padding: 6px 12px; border-radius: 6px; border: none; color: white; font-size: 14px; cursor: pointer; margin-top: 10px; transition: background-color 0.2s; background-color: #ef4444; }
        .popup-button-remove:hover { background-color: #dc2626; }
        .leaflet-top, .leaflet-bottom { z-index: 1000; }
        #storm-info-container, #address-list-panel-container, #cluster-slider-container, #top-right-controls { 
            transition: transform 0.3s ease-in-out, right 0.3s ease-in-out;
        }
        #storm-info-container.closed { transform: translateX(-100%); }
        
        #address-list-panel-container.closed { transform: translateY(100%); }
        @media (min-width: 640px) {
            #address-list-panel-container.closed { transform: translateX(100%) translateY(0); }
        }

        input[type=range] { -webkit-appearance: none; background: transparent; cursor: pointer; width: 100%; }
        input[type=range]::-webkit-slider-runnable-track { background: #e5e7eb; height: 0.5rem; border-radius: 0.25rem; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; margin-top: -4px; background-color: #3b82f6; height: 1.25rem; width: 1.25rem; border-radius: 9999px; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>

    <div id="login-container" class="absolute inset-0 z-[3000] flex items-center justify-center bg-gray-100">
        </div>
    
    <div id="app-container" class="h-full w-full hidden">
        <div id="map"></div>
        <div class="absolute top-0 left-1/2 -translate-x-1/2 mt-4 z-[1000] w-11/12 max-w-xl">
            </div>
        <div id="top-right-controls" class="absolute top-20 sm:top-4 right-4 z-[1000] flex flex-col items-end gap-2">
            </div>
        
        <div id="storm-info-container" class="absolute top-1/4 left-0 z-[1000] closed">
            <div id="storm-date-panel" class="bg-white/90 backdrop-blur-sm p-4 rounded-r-lg shadow-lg w-72">
                <div id="storm-list-view">
                    <h3 class="text-lg font-bold mb-2 text-gray-800">Storm Dates</h3>
                    <button id="search-storms-btn" class="w-full mb-3 px-4 py-2 bg-yellow-500 text-white text-sm font-semibold rounded-lg shadow-sm hover:bg-yellow-600 transition flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM9.38 15.25l-2.08-2.09 3.52-1.25-.79-2.21-3.51 1.25-2.09-2.08 1.3-1.3L8.65 12l-2.08-2.08 1.3-1.3 2.08 2.08 3.52-1.25-.79-2.21-3.51 1.25L7.3 5.12l1.3-1.3 2.08 2.09 3.51-1.25.79 2.21-3.52 1.25 2.09 2.08-1.3 1.3-2.08-2.08-3.51 1.25.79 2.21 3.52-1.25L14.65 12l2.08 2.08-1.3 1.3-2.08-2.09-3.52 1.25.79 2.21 3.51-1.25 2.08 2.09-1.3 1.3-2.08-2.09L9.38 15.25z"/></svg>
                        Search My Location
                    </button>
                    <div id="storm-date-list" class="space-y-2 max-h-64 overflow-y-auto"></div>
                    <button id="show-input-view-btn" class="w-full mt-3 px-4 py-2 bg-blue-600 text-white text-sm font-semibold rounded-lg shadow-sm hover:bg-blue-700 transition">Add Data Manually</button>
                </div>
                <div id="storm-input-view" class="hidden">
                    </div>
            </div>
            <div id="info-panel" class="mt-2 bg-white/90 backdrop-blur-sm p-3 rounded-r-lg shadow-lg hidden"></div>
            <button id="toggle-storm-panel" class="absolute left-full top-0 bg-white/90 p-2 rounded-r-lg shadow-lg font-semibold text-gray-700 flex flex-col items-center"><span>ðŸ“…</span><span>Storm Data</span></button>
        </div>

        <div id="address-list-panel-container" class="absolute bottom-0 left-0 w-full h-auto max-h-[60vh] rounded-t-lg z-[1000] closed sm:top-0 sm:right-0 sm:left-auto sm:bottom-auto sm:w-80 sm:h-full sm:max-h-full sm:rounded-none"></div>
        <div id="cluster-slider-container" class="absolute top-20 left-4 z-[1000] w-1/3 max-w-[200px] bg-white/90 p-2 rounded-full shadow-lg flex items-center gap-2 sm:bottom-4 sm:left-1/2 sm:-translate-x-1/2 sm:top-auto"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-functions.js"></script>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    
    <script>
        // --- Firebase Config and Global Vars ---
        const firebaseConfig = { /* ... your config ... */ };
        // ... all other global variables ...
        
        // --- Initialize Firebase ---
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const functions = firebase.functions();

        // ... All existing functions (Auth, Firestore, Markers, UI, etc.) ...

        // --- Event Listeners for UI controls ---
        // ... (all existing event listeners) ...

        // NEW: Event listener for the on-demand search button
        document.getElementById('search-storms-btn').addEventListener('click', () => {
            if (!navigator.geolocation) {
                return alert('Geolocation is not supported by your browser.');
            }
            showTemporaryMessage("Searching for recent storms near you...");
            navigator.geolocation.getCurrentPosition(async (position) => {
                const { latitude, longitude } = position.coords;
                try {
                    const getStormEvents = functions.httpsCallable('getStormEvents');
                    const result = await getStormEvents({ lat: latitude, lon: longitude });
                    if (result.data.resultCount === 0) {
                        return showTemporaryMessage("No recent hail events found in your area.");
                    }
                    
                    // Convert the JSON result from NOAA to a CSV string
                    let csvString = "ZTIME,CELL_ID,MAXSIZE,LAT,LON\n";
                    result.data.results.forEach(event => {
                        csvString += `${event.ZTIME},${event.CELL_ID},${event.MAXSIZE},${event.LAT},${event.LON}\n`;
                    });
                    
                    // Use our existing function to process the new data
                    processNewStormData(csvString);
                    showTemporaryMessage(`Found ${result.data.resultCount} storm events!`);
                } catch (error) {
                    console.error('Error calling cloud function:', error);
                    alert('Could not fetch storm data. Check console for details.');
                }
            }, () => {
                alert('Unable to retrieve your location.');
            });
        });
    </script>
</body>
</html>

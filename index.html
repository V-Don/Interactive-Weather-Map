<script>
    // --- START: Firebase Configuration ---
    const firebaseConfig = {
        apiKey: "AIzaSyACjzcs2Ofh7khctrYQU-LVHlg2wfyiWNM",
        authDomain: "storm-inspector-weather-map.firebaseapp.com",
        projectId: "storm-inspector-weather-map",
        storageBucket: "storm-inspector-weather-map.appspot.com",
        messagingSenderId: "504681972954",
        appId: "1:504681972954:web:029f4a4064a21a75eb51e3",
        measurementId: "G-H1413D9HN7"
    };
    // --- END: Firebase Configuration ---

    // --- Global App Variables ---
    let map;
    let currentUser = null;
    let stormData = [];
    let markers = L.markerClusterGroup({ maxClusterRadius: 80 });
    let swathLayer = L.layerGroup();
    const stormColors = ['#e41a1c', '#377eb8', '#4daf4a', '#984ea3', '#ff7f00', '#ffff33'];
    let suggestionTimeout;
    
    // --- Initialize Firebase ---
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- UI Element References ---
    const loginContainer = document.getElementById('login-container');
    const appContainer = document.getElementById('app-container');
    const googleSigninBtn = document.getElementById('google-signin-btn');
    const emailInput = document.getElementById('email-input');
    const emailSigninBtn = document.getElementById('email-signin-btn');
    const emailMessage = document.getElementById('email-message');
    const userEmailSpan = document.getElementById('user-email');
    const signoutBtn = document.getElementById('signout-btn');
    const addressInput = document.getElementById('address-input');
    const addressSuggestions = document.getElementById('address-suggestions');
    const uploadBtnDesktop = document.getElementById('upload-btn-desktop');
    const uploadBtnMobile = document.getElementById('upload-btn-mobile');

    // --- Map Initialization Function ---
    function initializeMap() {
        if (map) return;
        map = L.map('map', { zoomControl: false }).setView([33.88, -98.55], 8);
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            minZoom: 3,
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);
        map.addLayer(markers);
        swathLayer.addTo(map);
    }

    // --- Authentication Logic ---
    googleSigninBtn.addEventListener('click', () => {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch(error => console.error("Google Sign-In Error:", error));
    });
    emailSigninBtn.addEventListener('click', () => {
        const email = emailInput.value;
        if (!email) return alert("Please enter your email address.");
        const actionCodeSettings = { url: window.location.href, handleCodeInApp: true };
        auth.sendSignInLinkToEmail(email, actionCodeSettings)
            .then(() => {
                window.localStorage.setItem('emailForSignIn', email);
                emailMessage.textContent = "Login link sent! Please check your email.";
            })
            .catch(error => {
                console.error("Email Link Error:", error);
                emailMessage.textContent = "Error sending link. Please try again.";
            });
    });
    signoutBtn.addEventListener('click', () => auth.signOut());
    auth.onAuthStateChanged(user => {
        if (user) {
            currentUser = user;
            loginContainer.classList.add('hidden');
            appContainer.classList.remove('hidden');
            userEmailSpan.textContent = user.email;
            initializeMap();
            loadMarkersFromFirestore();
        } else {
            currentUser = null;
            loginContainer.classList.remove('hidden');
            appContainer.classList.add('hidden');
            if (markers) markers.clearLayers();
            if (swathLayer) swathLayer.clearLayers();
            if (map) {
                map.remove();
                map = null;
            }
        }
    });
    if (auth.isSignInWithEmailLink(window.location.href)) {
        let email = window.localStorage.getItem('emailForSignIn');
        if (!email) email = window.prompt('Please provide your email for confirmation');
        auth.signInWithEmailLink(email, window.location.href)
            .then(() => window.localStorage.removeItem('emailForSignIn'))
            .catch(error => console.error(error));
    }

    // --- Marker Icons ---
    const blueIcon = new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });
    const greenIcon = new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });
    const redIcon = new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });
    const yellowIcon = new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-yellow.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });

    // --- Firestore Data Functions ---
    async function loadMarkersFromFirestore() {
        if (!currentUser) return;
        markers.clearLayers();
        try {
            const querySnapshot = await db.collection('users').doc(currentUser.uid).collection('markers').get();
            querySnapshot.forEach(doc => {
                const markerData = doc.data();
                addMarker(markerData.lat, markerData.lon, markerData.address, {
                    id: markerData.id,
                    inspectionStatus: markerData.inspectionStatus,
                    shouldOpenPopup: false,
                    source: 'firestore'
                });
            });
        } catch (error) { console.error("Error loading markers from Firestore:", error); }
        updateAddressRemovalList();
    }
    async function saveMarkerToFirestore(markerData) {
        if (!currentUser) return;
        try {
            await db.collection('users').doc(currentUser.uid).collection('markers').doc(markerData.id).set(markerData);
        } catch (error) { console.error("Error saving marker to Firestore:", error); }
    }
    async function removeMarkerFromFirestore(markerId) {
        if (!currentUser) return;
        try {
            await db.collection('users').doc(currentUser.uid).collection('markers').doc(markerId).delete();
        } catch (error) { console.error("Error removing marker from Firestore:", error); }
    }
    async function removeAllMarkersFromFirestore() {
        if (!currentUser) return;
        const querySnapshot = await db.collection('users').doc(currentUser.uid).collection('markers').get();
        const batch = db.batch();
        querySnapshot.docs.forEach(doc => batch.delete(doc.ref));
        await batch.commit();
    }
    
    // --- Address Search & Geocoding ---
    async function fetchAddressSuggestions(query) {
         if (query.length < 3) {
            addressSuggestions.innerHTML = '';
            addressSuggestions.classList.add('hidden');
            return;
        }
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=us`;
        try {
            const response = await fetch(url);
            const data = await response.json();
            displaySuggestions(data);
        } catch (error) { console.error('Error fetching address suggestions:', error); }
    }
    function displaySuggestions(suggestions) {
        if (suggestions.length === 0) {
            addressSuggestions.innerHTML = '<div class="p-3 text-gray-500">No results found.</div>';
        } else {
            addressSuggestions.innerHTML = suggestions.slice(0, 5).map(s => `<div class="p-3 hover:bg-blue-100 cursor-pointer" data-lat="${s.lat}" data-lon="${s.lon}" data-name="${s.display_name}">${s.display_name}</div>`).join('');
        }
        addressSuggestions.classList.remove('hidden');
    }
    addressInput.addEventListener('keyup', (e) => {
        clearTimeout(suggestionTimeout);
        suggestionTimeout = setTimeout(() => fetchAddressSuggestions(e.target.value), 300);
    });
    addressSuggestions.addEventListener('click', (e) => {
        const suggestion = e.target.closest('div');
        if (suggestion) {
            const lat = parseFloat(suggestion.dataset.lat);
            const lon = parseFloat(suggestion.dataset.lon);
            const name = suggestion.dataset.name;
            addMarker(lat, lon, name);
            addressInput.value = '';
            addressSuggestions.classList.add('hidden');
        }
    });

    // --- Marker Management & UI Logic ---
    function addMarker(lat, lon, name, options = {}) { /* ... same as before ... */ }
    function createPopupContent(markerId, name) { /* ... same as before ... */ }
    function populatePopup(markerId, status) { /* ... same as before ... */ }
    window.updateMarkerStatus = function(markerId) { /* ... same as before ... */ }
    function updateMarkerIcon(marker) { /* ... same as before ... */ }
    window.removeMarker = function(markerId) { /* ... same as before ... */ }
    function updateAddressRemovalList() { /* ... same as before ... */ }
    window.zoomToMarker = function(markerId) { /* ... same as before ... */ }

    // --- Storm Data Logic (REFACTORED) ---
    function processNewStormData(csvText) {
        if (!csvText.trim()) {
            alert("No data to process.");
            return;
        }
        // Save to localStorage and re-process
        localStorage.setItem('userStormData', csvText);
        stormData = parseCsv(csvText);
        populateStormDatePanel();

        // Clear existing swaths and legend
        swathLayer.clearLayers();
        document.getElementById('legend-panel').classList.add('hidden');
        
        // Switch back to the list view
        document.getElementById('storm-input-view').classList.add('hidden');
        document.getElementById('storm-list-view').classList.remove('hidden');
    }
    function parseCsv(csvText) { /* ... same as before ... */ }
    function populateStormDatePanel() { /* ... same as before ... */ }
    window.handleDateSelection = function() { /* ... same as before ... */ }
    function drawHailSwath(pointsForDate, color) { /* ... same as before ... */ }

    // --- Event Listeners for UI controls ---
    document.getElementById('remove-selected-btn').addEventListener('click', () => { /* ... */ });
    document.getElementById('remove-all-btn').addEventListener('click', () => document.getElementById('confirmation-modal').classList.remove('hidden'));
    document.getElementById('confirm-remove').addEventListener('click', () => { /* ... */ });
    document.getElementById('cancel-remove').addEventListener('click', () => document.getElementById('confirmation-modal').classList.add('hidden'));
    uploadBtnDesktop.addEventListener('click', () => document.getElementById('upload-modal').classList.remove('hidden'));
    uploadBtnMobile.addEventListener('click', () => document.getElementById('upload-modal').classList.remove('hidden'));
    document.getElementById('cancel-upload').addEventListener('click', () => document.getElementById('upload-modal').classList.add('hidden'));
    document.getElementById('confirm-upload').addEventListener('click', handleUpload);
    document.getElementById('toggle-storm-panel').addEventListener('click', () => document.getElementById('storm-date-panel-container').classList.toggle('closed'));
    const toggleAddressListBtn = document.getElementById('toggle-address-list-btn');
    toggleAddressListBtn.addEventListener('click', () => { /* ... */ });
    document.getElementById('cluster-slider').addEventListener('input', (e) => { /* ... */ });
    document.querySelectorAll('input[name="filter"]').forEach(cb => cb.addEventListener('change', updateAddressRemovalList));
    
    // --- Storm Panel View Logic (MODIFIED) ---
    document.getElementById('show-input-view-btn').addEventListener('click', () => {
        document.getElementById('storm-list-view').classList.add('hidden');
        document.getElementById('storm-input-view').classList.remove('hidden');
    });
    document.getElementById('back-to-list-view-btn').addEventListener('click', () => {
        document.getElementById('storm-input-view').classList.add('hidden');
        document.getElementById('storm-list-view').classList.remove('hidden');
    });
    document.getElementById('process-storm-data-btn').addEventListener('click', () => {
        const newData = document.getElementById('storm-data-textarea').value;
        processNewStormData(newData);
    });
    // NEW: Event listener for the file input
    document.getElementById('storm-file-upload').addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            document.getElementById('storm-data-textarea').value = text; // Show content in textarea
            processNewStormData(text); // Process the data
        };
        reader.readAsText(file);
        event.target.value = ''; // Reset file input
    });

    // --- Mass Upload Logic ---
    async function handleUpload() { /* ... */ }
    function showTemporaryMessage(message) { /* ... */ }
    function parseFile(file) { /* ... */ }
    async function processAddressList(addresses) { /* ... */ }
    function createStatusIndicator() { /* ... */ }
    
    // --- Initial App Load ---
    function runOnLoad() { /* ... same as before ... */ }
    runOnLoad();

    // --- (Copying the full text of unchanged functions for completeness) ---
    function addMarker(lat, lon, name, options = {}) {
        const markerId = options.id || `marker-${Date.now()}`;
        const inspectionStatus = options.inspectionStatus || { inspected: false, damage: 'none', photoLink: '' };
        const shouldOpenPopup = options.shouldOpenPopup !== false;
        const marker = L.marker([lat, lon], { id: markerId, address: name, inspectionStatus: inspectionStatus });
        marker.bindPopup(() => createPopupContent(markerId, name, marker.options.inspectionStatus));
        marker.on('popupopen', () => populatePopup(markerId, marker.options.inspectionStatus));
        markers.addLayer(marker);
        updateMarkerIcon(marker);
        if (shouldOpenPopup) markers.zoomToShowLayer(marker, () => marker.openPopup());
        if (options.source !== 'firestore') {
            const markerData = { lat, lon, id: markerId, address: name, inspectionStatus };
            saveMarkerToFirestore(markerData);
        }
        updateAddressRemovalList();
    }
    function createPopupContent(markerId, name) { return `<div class="space-y-3"><p class="font-bold text-gray-800">${name}</p><div class="border-t pt-2"><label class="flex items-center"><input type="checkbox" id="inspected-${markerId}" class="h-4 w-4 rounded border-gray-300" onchange="updateMarkerStatus('${markerId}')"><span class="ml-2 font-semibold text-gray-700">Inspected</span></label></div><div id="damage-options-${markerId}" class="space-y-1 pl-4"><label><input type="radio" name="damage-${markerId}" value="damaged" onchange="updateMarkerStatus('${markerId}')" disabled> Damaged</label><br><label><input type="radio" name="damage-${markerId}" value="no_damage" onchange="updateMarkerStatus('${markerId}')" disabled> No Damage</label><br><label><input type="radio" name="damage-${markerId}" value="review" onchange="updateMarkerStatus('${markerId}')" disabled> Further Review</label></div><div><label for="photo-link-${markerId}" class="text-sm font-medium">Link to Photos</label><input type="text" id="photo-link-${markerId}" class="w-full p-1 border border-gray-300 rounded-md mt-1" oninput="updateMarkerStatus('${markerId}')"></div><button class="popup-button-remove" onclick="removeMarker('${markerId}')">Remove</button></div>`; }
    function populatePopup(markerId, status) {
        document.getElementById(`inspected-${markerId}`).checked = status.inspected;
        document.getElementById(`photo-link-${markerId}`).value = status.photoLink;
        const damageRadios = document.querySelectorAll(`input[name="damage-${markerId}"]`);
        damageRadios.forEach(radio => {
            radio.disabled = !status.inspected;
            if (radio.value === status.damage) radio.checked = true;
        });
    }
    window.updateMarkerStatus = function(markerId) {
        markers.eachLayer(layer => {
            if (layer.options.id === markerId) {
                const inspected = document.getElementById(`inspected-${markerId}`).checked;
                const photoLink = document.getElementById(`photo-link-${markerId}`).value;
                let damage = 'none';
                if (inspected) {
                    const selectedRadio = document.querySelector(`input[name="damage-${markerId}"]:checked`);
                    if (selectedRadio) damage = selectedRadio.value;
                }
                layer.options.inspectionStatus = { inspected, damage, photoLink };
                updateMarkerIcon(layer);
                document.querySelectorAll(`input[name="damage-${markerId}"]`).forEach(radio => radio.disabled = !inspected);
                const markerData = { lat: layer.getLatLng().lat, lon: layer.getLatLng().lng, id: layer.options.id, address: layer.options.address, inspectionStatus: layer.options.inspectionStatus };
                saveMarkerToFirestore(markerData);
                updateAddressRemovalList();
            }
        });
    }
    function updateMarkerIcon(marker) {
        const status = marker.options.inspectionStatus;
        if (!status.inspected) marker.setIcon(blueIcon);
        else {
            switch(status.damage) {
                case 'damaged': marker.setIcon(greenIcon); break;
                case 'no_damage': marker.setIcon(redIcon); break;
                case 'review': marker.setIcon(yellowIcon); break;
                default: marker.setIcon(blueIcon);
            }
        }
    }
    window.removeMarker = function(markerId) {
        markers.eachLayer(layer => {
            if (layer.options.id === markerId) markers.removeLayer(layer);
        });
        removeMarkerFromFirestore(markerId);
        updateAddressRemovalList();
    }
    function updateAddressRemovalList() {
        const layers = markers.getLayers();
        const addressListPanelContainer = document.getElementById('address-list-panel-container');
        const toggleAddressListBtn = document.getElementById('toggle-address-list-btn');
        const addressListContent = document.getElementById('address-list-content');
        const filters = {
            inspected: document.querySelector('input[name="filter"][value="inspected"]')?.checked,
            not_inspected: document.querySelector('input[name="filter"][value="not_inspected"]')?.checked,
            damaged: document.querySelector('input[name="filter"][value="damaged"]')?.checked,
            no_damage: document.querySelector('input[name="filter"][value="no_damage"]')?.checked,
            review: document.querySelector('input[name="filter"][value="review"]')?.checked,
        };
        const filteredLayers = layers.filter(l => {
            const status = l.options.inspectionStatus;
            const inspectedFilter = (filters.inspected && status.inspected) || (filters.not_inspected && !status.inspected) || (!filters.inspected && !filters.not_inspected);
            if (!inspectedFilter) return false;
            const damageFilters = ['damaged', 'no_damage', 'review'].filter(f => filters[f]);
            if (damageFilters.length > 0 && !damageFilters.includes(status.damage)) return false;
            return true;
        });
        if (layers.length > 0) {
            toggleAddressListBtn.classList.remove('hidden');
            addressListContent.innerHTML = filteredLayers.map(l => `<div class="p-1 rounded hover:bg-gray-200 cursor-pointer flex items-center" onclick="zoomToMarker('${l.options.id}')"><input type="radio" name="address-to-remove" value="${l.options.id}" class="h-4 w-4 mr-2"><span class="text-xs truncate">${l.options.address}</span></div>`).join('');
        } else {
            toggleAddressListBtn.classList.add('hidden');
            if(!addressListPanelContainer.classList.contains('closed')) {
                toggleAddressListBtn.click(); // Close the panel if it's open and list is empty
            }
            addressListContent.innerHTML = '';
        }
    }
    window.zoomToMarker = function(markerId) { markers.eachLayer(layer => { if (layer.options.id === markerId) markers.zoomToShowLayer(layer, () => layer.openPopup()); }); }
    function parseCsv(csvText) {
        const lines = csvText.trim().split('\n'); let allPoints = [], header = [];
        lines.forEach(line => {
            if (line.toLowerCase().startsWith('ztime')) { header = line.split(',').map(h => h.trim().toUpperCase()); return; }
            if (!line.includes(',') || header.length === 0) return;
            const values = line.split(',');
            const point = header.reduce((obj, nextKey, index) => { obj[nextKey] = values[index]; return obj; }, {});
            allPoints.push(point);
        });
        return allPoints;
    }
    function populateStormDatePanel() {
        const dailyMaxHail = {};
        stormData.forEach(event => { if (event.ZTIME && event.MAXSIZE) { const date = event.ZTIME.split('T')[0]; const size = parseFloat(event.MAXSIZE); if (size > 0 && (!dailyMaxHail[date] || size > dailyMaxHail[date])) dailyMaxHail[date] = size; } });
        const sortedDates = Object.entries(dailyMaxHail).sort((a, b) => new Date(b[0]) - new Date(a[0]));
        document.getElementById('storm-date-list').innerHTML = sortedDates.map(([date, size]) => `<label class="flex items-center"><input type="checkbox" class="h-4 w-4 rounded border-gray-300" onchange="handleDateSelection()" value="${date}"><span class="ml-2 text-gray-700">${date} (${size.toFixed(2)}" hail)</span></label>`).join('');
    }
    window.handleDateSelection = function() {
        swathLayer.clearLayers();
        const checkboxes = document.querySelectorAll('#storm-date-list input:checked');
        const selectedDates = Array.from(checkboxes).map(cb => cb.value);
        const legendPanel = document.getElementById('legend-panel');
        const legendContent = document.getElementById('legend-content');
        if (selectedDates.length === 0) return legendPanel.classList.add('hidden');
        legendPanel.classList.remove('hidden');
        legendContent.innerHTML = '';
        selectedDates.forEach((date, index) => {
            const color = stormColors[index % stormColors.length];
            const pointsForDate = stormData.filter(p => p.ZTIME && p.ZTIME.startsWith(date) && parseFloat(p.MAXSIZE) > 0);
            drawHailSwath(pointsForDate, color);
            if(pointsForDate.length > 0) {
                const maxHail = Math.max(...pointsForDate.map(p => parseFloat(p.MAXSIZE)));
                legendContent.innerHTML += `<div class="flex items-center"><div class="w-4 h-4 rounded-full mr-2" style="background-color: ${color};"></div><span>${date} (${maxHail.toFixed(2)}")</span></div>`;
            }
        });
    }
    function drawHailSwath(pointsForDate, color) {
        if(pointsForDate.length === 0) return;
        if (pointsForDate.length < 3) {
             pointsForDate.forEach(p => L.circle([parseFloat(p.LAT), parseFloat(p.LON)], { radius: 1609, color: color, weight: 1, opacity: 0.7, fillColor: color, fillOpacity: 0.2 }).addTo(swathLayer));
             return;
        };
        const turfPoints = pointsForDate.map(p => turf.point([parseFloat(p.LON), parseFloat(p.LAT)]));
        const hull = turf.convex(turf.featureCollection(turfPoints));
        if (hull) {
            const buffer1 = turf.buffer(hull, 1, {units: 'miles'});
            const buffer2 = turf.buffer(hull, 2, {units: 'miles'});
            L.geoJSON(buffer2, { style: () => ({ color: color, weight: 0, fillOpacity: 0.15, fillColor: color }) }).addTo(swathLayer);
            L.geoJSON(buffer1, { style: () => ({ color: color, weight: 0, fillOpacity: 0.2, fillColor: color }) }).addTo(swathLayer);
            L.geoJSON(hull, { style: () => ({ color: color, weight: 1, opacity: 0.6, fillColor: color, fillOpacity: 0.3 }) }).addTo(swathLayer);
        }
    }
    document.getElementById('remove-selected-btn').addEventListener('click', () => { const selectedRadio = document.querySelector('#address-list-content input[name="address-to-remove"]:checked'); if (selectedRadio) removeMarker(selectedRadio.value); });
    document.getElementById('remove-all-btn').addEventListener('click', () => document.getElementById('confirmation-modal').classList.remove('hidden'));
    document.getElementById('confirm-remove').addEventListener('click', () => { removeAllMarkersFromFirestore(); markers.clearLayers(); swathLayer.clearLayers(); document.getElementById('legend-panel').classList.add('hidden'); document.querySelectorAll('#storm-date-list input').forEach(cb => cb.checked = false); updateAddressRemovalList(); document.getElementById('confirmation-modal').classList.add('hidden'); });
    document.getElementById('cancel-remove').addEventListener('click', () => document.getElementById('confirmation-modal').classList.add('hidden'));
    document.getElementById('toggle-storm-panel').addEventListener('click', () => document.getElementById('storm-date-panel-container').classList.toggle('closed'));
    toggleAddressListBtn.addEventListener('click', () => {
        const panel = document.getElementById('address-list-panel-container'); const isClosed = panel.classList.toggle('closed');
        toggleAddressListBtn.classList.toggle('bg-white', isClosed); toggleAddressListBtn.classList.toggle('text-gray-700', isClosed);
        toggleAddressListBtn.classList.toggle('bg-red-600', !isClosed); toggleAddressListBtn.classList.toggle('text-white', !isClosed);
    });
    document.getElementById('cluster-slider').addEventListener('input', (e) => {
        if (!map) return;
        const newRadius = parseInt(e.target.value, 10); const allLayers = markers.getLayers();
        map.removeLayer(markers); markers = L.markerClusterGroup({ maxClusterRadius: newRadius });
        markers.addLayers(allLayers); map.addLayer(markers);
    });
    document.querySelectorAll('input[name="filter"]').forEach(cb => cb.addEventListener('change', updateAddressRemovalList));
    function runOnLoad() {
        const savedStormData = localStorage.getItem('userStormData');
        const defaultStormData = `ZTIME,WSR_ID,CELL_ID,PROB,SEVPROB,MAXSIZE,LAT,LON\n2025-03-30T01:09:44Z,KFWS,R0,100,20,0.5,33.914,-98.520\n2025-04-24T09:32:07Z,KFDR,U6,100,0,0.5,33.857,-98.522\n2025-04-30T01:22:25Z,KDYX,Z7,100,60,1.25,33.852,-98.518\n2025-04-05T06:41:29Z,KFWS,N3,100,100,3,33.852,-98.550`;
        stormData = parseCsv(savedStormData || defaultStormData);
        populateStormDatePanel();
    }
    runOnLoad();
</script>

</body>
</html>
